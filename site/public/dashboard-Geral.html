<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/Dashboard-Geral.css">
  <link rel="Logo icon" href="./assets/garrafa-de-vinho.png">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="./js/funcoes.js"></script>
  <title>Dashboard - Visao detalhada</title>
</head>

<body>


  <!-- Header -->
  <div class="header">
    <span> <img src="./assets/menu.png" alt="home" width="20px"></span>

    <div class="container">
      <div class="texto">
        <img class="user" src="./assets/user.png" alt="">
        <h1>Olá, <b id="b_usuario"></b>!</h1>
      </div>
      <img class="logo" src="./assets/logo2.png" alt="">
    </div>
  </div>


  <!-- Navbar -->
  <div class="container">
    <aside class="menu">
      <ul>
          <li><a href="dashboard.html"><img src="./assets/home.png" alt="home" width="22px" height="22px"></a>
          </li>

          <li><a href="dashboard-Geral.html" class="active"><img src="./assets/grafico.png" alt="monitoring" width="22px"
                      height="22px"></a></li>
          <li><a href="dashboardconfig.html" ><img src="./assets/localizacao.png" alt="settings"
                      width="22px" height="22px"></a></li>
          <li><a href="cadastroBarril.html" ><img src="./assets/barril.png" alt="settings"
                      width="22px" height="22px"></a></li>
          <li><a onclick="limparSessao()"><img src="./assets/porta.png" alt="logout" width="22px" height="22px">
              </a></li>
      </ul>
  </aside>
    <div>
    </div>

    <!-- Gráficos -->

    <main>

      <!-- Umidade -->
      <div class="container-total">
        <div class="container-temperatura">
          <div class="container-texto">
            <h3>Temperatura e Umidade Nas últimas 24 Horas</h3>
          </div>

          <div class="umidade-centralizar">
            <div class="caixa-alinhamento">
              <div class="dashboard">
                <canvas id="myChart" style="width: 680px; height: 400px;"></canvas>
              </div>
            </div>
          </div>

        </div>



        <!-- Temperatura -->
        <div class="container-temperatura">
          <div class="container-texto">
            <h3>Gráfico De Temperatura Nas últimas 24 Horas</h3>
          </div>

          <div class="container-texto">
            <h3>Métricas Umidade</h3>
          </div>

          <div class="alinhamento-metricas">

            <div class="caixa1">
              <div class="caixa-alertas">
                <div class="perigo">
                  <div class="alinhar-texto">
                    <h2 class="texto-metrica">Perigo</h2>
                    <h2 class="numero-alerta">50%</h2>
                  </div>
                </div>
              </div>


              <div class="caixa-alertas">
                <div class="alerta">
                  <div class="alinhar-texto">
                    <h2 class="texto-metrica">Alerta</h2>
                    <h2 class="numero-alerta">52%</h2>
                  </div>
                </div>
              </div>

              <div class="caixa-alertas">
                <div class="ideal">
                  <div class="alinhar-texto">
                    <h2 class="texto-metrica">Ideal</h2>
                    <h2 class="numero-alerta">56%</h2>
                  </div>
                </div>
              </div>


              <div class="caixa-alertas">
                <div class="alerta-quente">
                  <div class="alinhar-texto">
                    <h2 class="texto-metrica">Alerta</h2>
                    <h2 class="numero-alerta">58%</h2>
                  </div>
                </div>
              </div>

              <div class="caixa-alertas">
                <div class="perigo-quente">
                  <div class="alinhar-texto">
                    <h2 class="texto-metrica">Perigo</h2>
                    <h2 class="numero-alerta">60%</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="container-texto">
            <h3>Métricas Temperatura</h3>
          </div>

          <div class="caixa2">
            <div class="caixa-alertas">
              <div class="perigo">
                <div class="alinhar-texto">
                  <h2 class="texto-metrica">Perigo</h2>
                  <h2 class="numero-alerta">12ºC</h2>
                </div>
              </div>
            </div>

            <div class="caixa-alertas">
              <div class="alerta">
                <div class="alinhar-texto">
                  <h2 class="texto-metrica">Alerta</h2>
                  <h2 class="numero-alerta">13ºC</h2>
                </div>
              </div>
            </div>

            <div class="caixa-alertas">
              <div class="ideal">
                <div class="alinhar-texto">
                  <h2 class="texto-metrica">Ideal</h2>
                  <h2 class="numero-alerta">15ºC</h2>
                </div>
              </div>
            </div>


            <div class="caixa-alertas">
              <div class="alerta-quente">
                <div class="alinhar-texto">
                  <h2 class="texto-metrica">Alerta</h2>
                  <h2 class="numero-alerta">17ºC</h2>
                </div>
              </div>
            </div>

            <div class="caixa-alertas">
              <div class="perigo-quente">
                <div class="alinhar-texto">
                  <h2 class="texto-metrica">Perigo</h2>
                  <h2 class="numero-alerta">18ºC</h2>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- Footer -->
  </div>
  <footer> Copyright &copy; 2022 Soluções Grand Vinum - Todos os direitos reservados - Desenvolvido por Grand Vinum
  </footer>
  </main>
</body>


<script>

  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
  var idUsuario = sessionStorage.getItem("ID_USUARIO")


  window.onload = carregarDadosPeriodo();

  function carregarDadosPeriodo() {

    var idBarril = sessionStorage.getItem("FK_BARRIL_VINHO")

    fetch(`/medidas/carregarDadosPeriodo/${idBarril}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGrafico(resposta, idBarril);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*
  function plotarGrafico(resposta, idBarril) {
    console.log('iniciando plotagem do gráfico...');

    // Criando estrutura para plotar gráfico - labels
    let labels = [];

    // Criando estrutura para plotar gráfico - dados
    let dados = {
      labels: labels,
      datasets: [{
        label: 'Umidade',
        data: [],
        fill: false,
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      },
      {
        label: 'Temperatura',
        data: [],
        fill: false,
        borderColor: 'rgb(199, 52, 52)',
        tension: 0.1
      }]
    };

    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(resposta)

    // Inserindo valores recebidos em estrutura para plotar o gráfico
    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      labels.push(registro.data_hora);
      dados.datasets[0].data.push(registro.umidade);
      dados.datasets[1].data.push(registro.temperatura);
    }

    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels:')
    console.log(labels)
    console.log('Dados:')
    console.log(dados.datasets)
    console.log('----------------------------------------------')

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: 'line',
      data: dados,
    };

    // Adicionando gráfico criado em div na tela
    let myChart = new Chart(
      document.getElementById('myChart'),
      config
    );

  }

</script>